<!DOCTYPE html><html lang="en"><head><title>Simple Linux/BSD service monitoring script - Lietu's tech blog - Lietu's homepage</title><meta name="description" content="Janne Enberg, aka. Lietu's homepage"><meta name="keywords" content="Janne Enberg Lietu programmer IT generalist homepage"><link href='http://fonts.googleapis.com/css?family=Open+Sans:400,600,800' rel='stylesheet' type='text/css'><link href='/assets/global-01852371966e6ab602598d856f6fb404.css' rel='stylesheet' type='text/css'/> <script src="http://code.jquery.com/jquery-1.8.3.min.js"></script><script src='/assets/global-eb0b8eea4ca1154082ff522f29d0194d.js'></script></head><body> <header><h1><a href="/">Lietu's homepage</a></h1> </header><div class="container"><div class="row"><div class="page span12"><div class="navbar navbar-inverse"><div class="navbar-inner"><div class="container"> <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></a><div class="nav-collapse collapse"><ul class="nav"><li><a href="/" title="Home"><i class="icon-home icon-white"></i></a></li><li><a href="/blog.html" title="Lietu's tech blog">Tech Blog</a></li><li><a href="/about.html" title="About Lietu">About</a></li><li><a href="/credits.html" title="Credits">Credits</a></li><li><a href="/links.html" title="Links to more resources">Links</a></li><li><a href="/cv.html" title="Curriculum Vitae - Janne Enberg">Curriculum Vitae</a></li></ul></div></div></div></div><div class="content"><section class="blog" itemscope itemtype="http://schema.org/Blog"><div class="span11"><h2 itemprop="name">Lietu's tech blog</h2></span></div><div class="span11 description"><span itemprop="description">Yet another techie blog by Janne Enberg, aka. Lietu</span></div><div class="span9 blog-content"><article itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPost" class="well"><h3 itemprop="name">Simple Linux/BSD service monitoring script</h3><div class="post-date">Posted <span itemprop="datePublished" class="date">2012-09-17</span></div><div itemprop="articleBody"><p>Here's a simple script to monitor the status of a service via a normal control script such as /etc/init.d/varnishd as commonly found under Linux and BSD based systems .. it should be super simple to modify for most other types of systems, such as systemctl.</p><p>Just configure, place somewhere on the server, and set a crontab line to run it every now and then.</p><div class="highlight"><pre><code class="bash"><span class="c">#!/usr/bin/env bash</span>

<span class="c"># ----- ------------- ----- #</span>
<span class="c"># ----- CONFIGURATION ----- #</span>
<span class="c"># ----- ------------- ----- #</span>

<span class="c"># Path to control script (usually in rc.d or init.d)</span>
<span class="nv">SERVICED</span><span class="o">=</span><span class="s2">"/usr/local/etc/rc.d/varnishd"</span>

<span class="c"># Who should get crash notifications</span>
<span class="nv">EMAIL_RECIPIENT</span><span class="o">=</span><span class="s2">"recipient@example.com"</span>

<span class="c"># Subject of the crash notification</span>
<span class="nv">EMAIL_SUBJECT</span><span class="o">=</span><span class="s2">"${SERVICED} crash detected"</span>


<span class="c"># ----- ------------ ----- #</span>
<span class="c"># ----- SCRIPT LOGIC ----- #</span>
<span class="c"># ----- ------------ ----- #</span>

<span class="c"># Check status</span>
<span class="s2">"${SERVICED}"</span> status &gt; /dev/null 2&gt;&amp;1
<span class="nv">service_status</span><span class="o">=</span><span class="nv">$?</span>

<span class="c"># Exit code will be 1 if varnish is not running</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$service_status</span> -eq 1 <span class="o">]</span>; <span class="k">then</span>

<span class="k"> </span><span class="nv">service_start_message</span><span class="o">=</span><span class="k">$(</span><span class="s2">"${SERVICED}"</span> start 2&gt;&amp;1<span class="k">)</span>

 <span class="nv">host</span><span class="o">=</span><span class="k">$(</span>uname -n<span class="k">)</span>
 <span class="nv">uptime</span><span class="o">=</span><span class="k">$(</span>uptime<span class="k">)</span>

 <span class="nv">email_message</span><span class="o">=</span><span class="s2">"Service ${SERVICED} seems to have crashed on host ${host}.</span>

<span class="s2">Uptime:</span>
<span class="s2">${uptime}</span>

<span class="s2">Messages from trying to restart it:</span>
<span class="s2">${service_start_message}</span>
<span class="s2">"</span>

 <span class="c"># Send email</span>
 <span class="nb">echo</span> <span class="s2">"${email_message}"</span> | mail -s<span class="s2">"${EMAIL_SUBJECT}"</span> <span class="s2">"${EMAIL_RECIPIENT}"</span>

 <span class="k">fi</span>

</code></pre></div></div> <small>Copyright © 2012 Janne Enberg. All rights reserved.</small> </article></div><div class="span2 sidebar well"><h3>About</h3><div class="about-blog" itemscope itemtype="http://schema.org/Person"> <img src="/img/blog/lietu.jpg" itemprop="image"/><p>The author, <span itemprop="name">Janne Enberg</span> aka. <a href="http://lietu.net/">Lietu</a>, is an IT generalist from Espoo, Finland.</p></div><h3>Posts</h3><div class="sidebar-post"> <span class="date">2012-12-26</span> <a href="/2012/12/jekyll.html" title="Jekyll">Jekyll</a></div><div class="sidebar-post"> <span class="date">2012-12-23</span> <a href="/2012/12/linux-and-sleep-mode-wakeup.html" title="Linux and sleep mode wakeup">Linux and sleep mode wakeup</a></div><div class="sidebar-post"> <span class="date">2012-12-22</span> <a href="/2012/12/windows-and-sleep-mode.html" title="Windows and sleep mode">Windows and sleep mode</a></div><div class="sidebar-post"> <span class="date">2012-11-04</span> <a href="/2012/11/vmware-esxi-freenas-nfs-vs-iscsi.html" title="VMware ESXi + FreeNAS, NFS vs. iSCSI performance">VMware ESXi + FreeNAS, NFS vs. iSCSI performance</a></div><div class="sidebar-post"> <span class="date">2012-09-17</span> <a href="/2012/09/simple-linuxbsd-service-monitoring.html" title="Simple Linux/BSD service monitoring script">Simple Linux/BSD service monitoring script</a></div><div class="sidebar-post"> <span class="date">2012-07-29</span> <a href="/2012/07/installing-mageia-2-or-most-linux.html" title="Installing Mageia 2 (or most Linux systems) on Mac Mini 4.1 (mid 2010 edition) (and probably other Macs too)">Installing Mageia 2 (or most Linux systems) on Mac Mini 4.1 (mid 2010 edition) (and probably other Macs too)</a></div><div class="sidebar-post"> <span class="date">2012-05-02</span> <a href="/2012/05/creating-ubuntu-server-virtual-machine.html" title="Creating an Ubuntu Server virtual machine with Node.js">Creating an Ubuntu Server virtual machine with Node.js</a></div></div> </section></div></div></div><div class="push"></div></div><footer><p> Copyright © 2013 by Janne Enberg. All rights reserved.<br/> Last updated 2013-01-04 18:31:08</p> </footer><div id="imgModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="imgModalLabel" aria-hidden="true"><div class="modal-header"> <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button><h3 id="imgModalLabel">Original version</h3></div><div class="modal-body"> <img/></div><div class="modal-footer"> <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button></div></div></body></html>